#!/usr/bin/env ruby

require "bundler/setup"
require 'mongoid'
Mongoid.load!("config/mongoid.yml", :development)
require File.expand_path('../../models/models', __FILE__)

if ARGV[0] == 'new'
  puts "--> Cleaning"

  DbCounter.destroy_all
  Quote.destroy_all
end

manager = Manager.new(:dueling_bulldozer_dealer)

count = Quote.count

loop do
  puts "--> Starting sampling"
  manager.dispatch
  break if Quote.count - count >= 6
end

loop do
  puts "--> Starting dealing"
  manager.dispatch

  manager.deal do |dealers|
    dealers.each_with_index do |dealer, idx|
      if idx.even?
        dealer.async.deal_buy_low_first
        # dealer.async.deal_buy_first
      else
        dealer.async.deal_sell_high_first
        # dealer.async.deal_sell_first
      end
    end
  end
end
